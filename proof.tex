\section{Proof of Lemmas}
\label{sec:proof}

\begin{lemma}
\label{lem:okPreserved}
If \(\OK_n(P)\) and \(P \xlongrightarrow{\rho} P'\), then
\begin{itemize}
\item \(\OK_{n-1}(P')\) if \(\rho = \Malloc\),
\item \(\OK_{n+1}(P')\) if \(\rho = \Free\), and
\item \(\OK_n(P')\) if \(\rho = \tau\).
\end{itemize}
\end{lemma}
\begin{proof}

Case analysis on \(P \xlongrightarrow{\rho} P'\).

\todo{To be revised.}

\noindent Case $P = \TSKIP;P'$\\

According to rule E-Skip, we should prove
$\sharp_{m}(P')-\sharp_{f}(P') \le n'$ where $n'$ is $n$.

Because we have
\begin{eqnarray*}
  OK_{n}(P)  & & =  OK_{n}(\SKIP;P')\\
  & & \Rightarrow \sharp_{m}(\SKIP;P') - \sharp_{f}(\SKIP;P') \le n \\
  & & \Rightarrow \sharp_{m}(P') - \sharp_{f}(P') \le n \
\end{eqnarray*}
Then it is proved. \\

\noindent Case $P = \Malloc;P'$ \\

Here according to rule E-Malloc, we know the $n'$ is $n-1$.

Therefore we should prove $\sharp_{m}(P') - \sharp_{f}(P') \le n-1$
\begin{eqnarray*}
  OK_{n}(P)&& =  OK_{n}(\Malloc;P')\\
  &&\Rightarrow \sharp_{m}(\Malloc;P') - \sharp_{f}(\Malloc;P') \le n \\
  &&\Rightarrow  \sharp_{m}(P') + 1 - \sharp_{f}(P') \le n\\
  &&\Rightarrow  \sharp_{m}(P')  - \sharp_{f}(P') \le n-1\\
\end{eqnarray*}

Then it is proved.\\

\noindent Case $P = \Free;P'$ \\

According to rule E-Free, we should prove $\sharp_{m}(P') - \sharp_{f}(P') \le n+1$.

\begin{eqnarray*}
  OK_{n}(P)  & & =  OK_{n}(\Free;P')\\
  & &\Rightarrow  \sharp_{m}(\Free;P') - \sharp_{f}(\Free;P') \le n \\
  & & \Rightarrow \sharp_{m}(P')  - \sharp_{f}(P') - 1  \le n\\
  & & \Rightarrow \sharp_{m}(P')  - \sharp_{f}(P') \le n+1\\
\end{eqnarray*}

Then it is proved. \\

\noindent Case $P = P_{1};P_{2}$\\

To prove it by contradiction.

Suppose that $OK_{n'}(P_{1}';P_{2})$ does not hold. Then we have 
$P_{1};P_{2} \xlongrightarrow{\alpha} P_{1}';P_{2} \xlongrightarrow{\exists \sigma} Q$, $s.t.$ $\sharp_{m}(\sigma) - \sharp_{f}(\sigma) > n'$\\

From the premise $OK_{n}(P) = OK_{n}(P_{1};P_{2})$, we get 
\setcounter{equation}{0}
\begin{align}
  &  \sharp_{m}(\alpha \cdot \sigma) - \sharp_{f}(\alpha \cdot \sigma) \le n \label{eqok1.1}
\end{align}

From \eqref{eqok1.1}, we get
\begin{align}
\sharp_{m}(\alpha) + \sharp_{m}(\sigma) - \sharp_{f}(\alpha) - \sharp_{f}(\sigma) \  \label{eqok1.2}
\end{align}
and with
$$
   n'=\left\{
   \begin{aligned}
     n + 1, && \alpha = \Free \\
     n - 1,  && \alpha = \Malloc  \\
     n ,      && otherwise
   \end{aligned}
   \right.
$$
Therefore, we get \\
$n' + \sharp_{m}(\alpha) - \sharp_{f}(\alpha) < \sharp_{m}(\alpha) + \sharp_{m}(\sigma) - \sharp_{f}(\alpha) - \sharp_{f}(\sigma) \le n $ \\
When $\alpha = \Free$, we get that $n + 1 - 1 < n$\\
When $\alpha = \Malloc$, we get that $ n - 1 + 1 < n $ \\
When $ \alpha = other$,  we  get that $ n < n $ \\
 All of the three cases are equal to $n$. Therefore we get the contradiction.
\end{proof}

\begin{pfof}{Lemma~\ref{}}
By induction on the derivation of evaluation rules.\\

\begin{itemize}
\item Case: $\langle H, R, \FREE, n \rangle \xlongrightarrow{\Free}
  \langle H', R', \SKIP, n + 1 \rangle $.

We have \(\OK_n(P)\) and \(\Theta; \Gamma \vdash \Free(x) \COL P\).
From inversion of the typing rules, we have \(\Theta; \Gamma \vdash
\Free(x) \COL \Free\) and \(\Free \le P\) for some \(P'\).  Hence,
from the definition of subtyping, we have \(\TSKIP \le P''\) and \(P
\xLongrightarrow{\Free} P''\) for some \(P''\).

We need to find \(P_1\) such that \(P \xLongrightarrow{\Free} P_1\),
\(\Theta; \Gamma \vdash \SKIP \COL P_1\), and \(\OK_{n+1}(P_1)\).
Take \(P''\) as \(P_1\).  Then, \(P \xLongrightarrow{\Free} P''\) as
we stated above.  We also have \(\Theta; \Gamma \vdash \SKIP \COL
P''\) from \rn{T-Skip}, \(\TSKIP \le P''\), and \rn{T-Sub}.
\(\OK_{n+1}(P'')\) follows from Lemma~\ref{lem:okPreserved}.


\item Case: $\langle H, R, \LET x = \MALLOC \IN s, n \rangle
  \xlongrightarrow{\Malloc} \langle H', R', [x'/x]s, n - 1 \rangle
  $.

  From the assumption, we have \(\Theta; \Gamma \vdash \LET x =
  \MALLOC \IN s \COL P\) and \(\OK_{n}(P)\). By the inversion of
  typing rules, we have \(\Malloc;P_1 \le P\) and \(\Theta; \Gamma
  \vdash s : P_{1}\) for some \(P_1\). We have the following
  derivation: \infrule{ \Malloc \xlongrightarrow{\Malloc} 0}
  {\Malloc;P_1 \xlongrightarrow{\Malloc} 0;P_{1}} and \(0;P_1
  \rightarrow P_{1}\), then we have \(\Malloc;P_{1}
  \xLongrightarrow{\Malloc} P_{1}\). Hence, By the definition of
  subtyping, we have \(P \xLongrightarrow{\Malloc}P''\) and \(P_{1}
  \le P''\) for some \(P''\)

  We need to find \(P'\) such that \(\Theta; \Gamma' \vdash
  [x'/x]s\COL P'\),\(P\xLongrightarrow{\Malloc} P'\). Take \(P''\) as
  \(P'\). Then \(P \xLongrightarrow{\Malloc} P''\) as we state above. We
  also have \(\Theta;\Gamma \vdash [x'/x]s \COL P''\) from \(T-Sub\),
  \(\Theta;\Gamma \vdash [x'/x]s \COL P_1\) and \(P_1 \le
  P''\). \(\OK_{n-1}(P'')\) follows from Lemma~\ref{lem:okPreserved}.

\item Case: $\langle H, R, \SKIP;s, n \rangle \rightarrow \langle
  H, R, s, n \rangle $.

  we have \(\Theta;\Gamma \vdash \SKIP;s\COL  P\) and
  \(\OK_{n}(P)\). From the inversion of the typing rules, we have
  \(\Theta; \Gamma \vdash s\COL P_{1}\) and \(0;P_{1} \le
  P\). Hence, from the definition of subtyping, we have \(P
  \rightarrow^{*} P''\) and \(P_{1} \le P''\) for some \(P''\).

  We need to find \(P'\) such that \(\Theta; \Gamma \vdash s : P'
  and \(P \rightarrow^{*} P'\). Take \(P''\) as \(P'\). Then \(P
  \(rightarrow^{*} P''\) as we stated above. We also have
  \(\Theta;\Gamma \vdash s\COL P''\) from \(T-Sub\), \(\Gamma \vdash
  s\COL P_{1}\) and \(P_{1} \le P''\). \(\OK_n(P'')\) follows from
  Lemma~\ref{lem:okPreserved}

\item Case: $\langle H, R, *x \leftarrow y , n \rangle \rightarrow
  \langle H', R', \SKIP, n \rangle $.

  We have \(\Theta; \Gamma \vdash *x \leftarrow y : P\) and
  \(\OK_{n}(P)\). From the inversion of typing rules, we have \(0 \le
  P\).

  We need to find $P'$ such that \(\Theta; \Gamma \vdash \SKIP: P'\),
  \(P \rightarrow^{*} P'\) and \(\OK_n(P')\). Take $P$ as $P'$. Then,
  \(P \rightarrow^{*} P'\) and \(\OK_n(P')\) hold. We also have \(\Theta;
  \Gamma \vdash \SKIP: P'\) from \(T-Skip\), \(0 \le P\) and
  \(T-Sub\).

\item Case: $\langle H, R, \LET x = y\ \IN s , n \rangle
  \rightarrow \langle H', R', [x'/x]s, n \rangle $.

  We have \(\Theta; \Gamma \vdash \LET x = y\ \IN \ s \COL P\) and
  \(OK_{n}(P)\). From the inversion of typing rules, we have \(\Theta;
  \Gamma \vdash s\COL P_{1}\) and \(P_{1} \le P\).

  We need to find $P'$ such that \(\Theta; \Gamma \vdash [x'/x]s : P'\) ,
  \(P \xlongrightarrow{\tau}^{*} P'\) and \(\OK_n(P'\)). Take \(P\) as
  \(P'\). Then \( P \rightarrow^{*} P'\) and \(\OK\n(P')\) hold.  We
  also have \(\Theta; \Gamma \vdash [x'/x]s\COL P\) from \(T-Sub\),
  \(\Theta; \Gamma \vdash [x'/x]s\COL P_{1}\) and \( P_{1} \le
  P}.

\item Case: $\langle H, R, \LET x = \NULL \ \IN \ s, n \rangle
  \rightarrow \langle H', R', [x'/x]s, n \rangle $

  We have \(\Theta; \Gamma \vdash \LET x = \NULL \ \IN \ s\COL P\)
  and \(OK_{n}(P)\). From the inversion of typing rules, we have
  \(\Theta; \Gamma \vdash s\COL P_{1}\) and \( P_{1} \le P\).

  We need to find $P'$ such that \(\Theta; \Gamma' \vdash [x'/x]s\COL P'\),
  \(P \rightarrow^{*} P'\) and \(\OK_n(P')\).  Take \(P\) as
  \(P'\).  Then, \(P \rightarrow^{*} P'\) and \(\OK_n(P')\) hold.  We
  also have \(\Theta; \Gamma \vdash [x'/x]s\COL P\) from \(T-Sub\),
  \(\Theta; \Gamma \vdash [x'/x]s\COL P_{1}\)\( P_{1} \le
  P\). 

\item Case: $\langle H, R, \LET x = *y \ \IN \ s, n \rangle
  \rightarrow \langle H', R', [x'/x]s, n \rangle $

  We have \(\Theta; \Gamma \vdash \LET x = *y \ \IN \ s\COL  P\) and
  \(OK_{n}(P)\). From the inversion of typing rules, we have \(\Theta;
  \Gamma \vdash s\COL P_{1}\) and \(P_{1} \le P\).

  We need to find \(P'\) such that \(\Theta; \Gamma \vdash [x'/x]s\COL
  P'\), \(P \rightarrow^{*} P'\) and \(\OK_n(P')\). Take \(P\) as
  \(P'\). Then, \(P \rightarrow^{*} P'\) and \(\OK_n(P')\) hold.  We
  also have \(\Theta; \Gamma' \vdash [x'/x]s\COL P\) from \(T-Sub\),
  \(\Theta; \Gamma' \vdash [x'/x]s\COL P_{1}\) and \(P_{1} \le P\).
        
\item Case(\(Tr-IfNullT\)): \(langle H, R, \IFNULL \Cirx \ \THEN s_{1} \ \ELSE \ s_{2},
  n \rangle \rightarrow \langle H, R, s_{1}, n \rangle\)

  We have \(\Theta; \Gamma \vdash \IFNULL \Cirx \ \THEN \ s_{1}
  \ \ELSE \ s_{2}\COL P\) and \(\OK_{n}(P)\). From the inversion of
  typing rules, we have \(\Theta; \Gamma \vdash s_{1} : P_{1}\) and \(P_{1}
  \le P\).

  We need to find $P'$ such that \(\Theta; \Gamma \vdash s_1\COL P'\)
  , \(P \rightarrow^{*} P'\) and \(\OK_n(P'\)).  Take P as P'.  Then,
  \(\OK_n(P')\) and \(P \rightarrow^{*} P'\). We also have \(\Theta;
  \Gamma' \vdash s_{1}\COL P\) from \(\Theta; \Gamma \vdash s_{1}\COL
  P_1\), \(P_{1} \le P\) and \(T-Sub\).

\item Case(\(Tr-IfNullF\)): \(langle H, R, \IFNULL \Cirx \ \THEN s_{1} \ \ELSE \ s_{2},
  n \rangle \rightarrow \langle H, R, s_{2}, n \rangle\).

 The proof is similar to case \(Tr-IfNullT\). 

\item Case: $\langle H, R, f(\vec{x}) , n \rangle \rightarrow  \langle H, R, [\vec{x}/\vec{y}]s, n  \rangle $

  Assuming that \(D(f) = s\) and \(\Theta(f) = P_1\), we have \(s\COL
  P_1\). The \([\vec{x}/\vec{y}]s\) also has a type \(P_1\).

  From the assumption, we have \(\Theta;\Gamma \vdash f(x)\COL P\) and
  \(\OK_n(P)\). From the inversion, we have \(\Theta;\Gamma \vdash
  f(x)\COL P_1\) and \(P_1 \le P\).

  We need to find \(P'\) such that \(\Theta;\Gamma \vdash [\vec{x}/\vec{y}]s\COL
  P'\), \(P \rightarrow P'\) and \(\OK_n(P')\). Take \(P\) as
  \(P'\). Then \(P \rightarrow P'\) and \(\OK_n(P')\) are held. We
  also have \(\Theta;\Gamma \vdash [\vec{x}/\vec{y}]s\COL P \) from
  \(\Theta;\Gamma \vdash [\vec{x}/\vec{y}]s\COL P_1)\), \(P_1 \le P\) and
  \(T-Sub\).

\end{pfof}
